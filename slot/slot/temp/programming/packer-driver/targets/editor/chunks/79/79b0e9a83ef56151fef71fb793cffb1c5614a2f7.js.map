{"version":3,"sources":["file:///C:/Users/eulao/OneDrive/Desktop/COCOSSLOT/cocos_slot/slot/slot/assets/scripts/services/GameService.ts"],"names":["GameService","Vec3","resources","instantiate","Prefab","tween","Label","SlotPicturesEnum","pictureHeight","bingoTime","layer1Pics","layer2Pics","layer3Pics","initGame","layout1","layout2","layout3","push","node","getChildByName","resetGameProperty","removeLayersChildren","resetLayers","startRolling","bingoNode","audioManager","playRollingMusic","generateAllPictureRoll","tweenAllLayerPicture","then","checkResult","active","playBingoMusic","getComponent","string","toString","getPicturePath","pictureNumber","layer1","layer2","layer3","layer1Result","findLast","item","layer2Result","layer3Result","name","removeChilds","layout","pictureArray","lastNode","removeChild","splice","length","resetLayout","setPosition","generatePictureRoll","picutreArray","promises","i","num","Math","floor","random","promise","Promise","resolve","reject","load","err","prefab","newNode","nodes","all","shuffledNodes","sort","forEach","index","insertChild","tweenPictures","to","position","easing","call","start"],"mappings":"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","sourcesContent":["import { _decorator, Node, Layout, Vec3, resources, instantiate, Prefab, tween, Label } from 'cc';\r\nimport SlotPicturesEnum from \"../../utils/SlotPicturesEnum\";\r\n\r\nexport class GameService {\r\n\r\n    private pictureHeight:number = 450\r\n\r\n    private bingoTime:number = 0\r\n\r\n    private layer1Pics:Node[] = []\r\n\r\n    private layer2Pics:Node[] = []\r\n\r\n    private layer3Pics:Node[] = []\r\n\r\n\r\n    /**\r\n     * 遊戲初始化\r\n     * @param layout1 \r\n     * @param layout2 \r\n     * @param layout3 \r\n     */\r\n    initGame(layout1:Layout, layout2:Layout, layout3:Layout){\r\n        \r\n        this.layer1Pics.push(layout1.node.getChildByName(\"SLOT_Picture1\"))\r\n        this.layer2Pics.push(layout2.node.getChildByName(\"SLOT_Picture1\"))\r\n        this.layer3Pics.push(layout3.node.getChildByName(\"SLOT_Picture1\"))\r\n\r\n    }\r\n\r\n    /**\r\n     * 重製遊戲的layer位置以及保存picture的陣列\r\n     * @param layout1 \r\n     * @param layout2 \r\n     * @param layout3 \r\n     */\r\n    resetGameProperty(layout1:Layout, layout2:Layout, layout3:Layout){\r\n\r\n        this.removeLayersChildren(layout1, layout2, layout3, this.layer1Pics, this.layer2Pics, this.layer3Pics)\r\n        this.resetLayers(layout1, layout2, layout3)\r\n\r\n    }\r\n\r\n    /**\r\n     * 開始滾動\r\n     * @param bingoNode \r\n     * @param audioManager \r\n     * @param layout1 \r\n     * @param layout2 \r\n     * @param layout3 \r\n     */\r\n    async startRolling(bingoNode:Node, audioManager:MusicController, layout1:Layout, layout2:Layout, layout3:Layout){\r\n\r\n        audioManager.playRollingMusic()\r\n\r\n        await this.generateAllPictureRoll(layout1, layout2, layout3, this.layer1Pics, this.layer2Pics, this.layer3Pics)\r\n\r\n        this.tweenAllLayerPicture(layout1, layout2, layout3).then(()=>{\r\n            if(this.checkResult(this.layer1Pics, this.layer2Pics, this.layer3Pics)){\r\n                bingoNode.active = true\r\n                audioManager.playBingoMusic()\r\n                bingoNode.getChildByName('Score').getComponent(Label).string = (++this.bingoTime*100).toString()\r\n            }\r\n        })\r\n    }\r\n\r\n\r\n    /**\r\n     * 取得圖片路徑\r\n     * @param pictureNumber \r\n     * @returns \r\n     */\r\n    getPicturePath(pictureNumber:number){\r\n\r\n        return SlotPicturesEnum[pictureNumber]\r\n\r\n    }\r\n\r\n    /**\r\n     * 確認是否中獎\r\n     * @param layer1 \r\n     * @param layer2 \r\n     * @param layer3 \r\n     * @returns \r\n     */\r\n    checkResult(layer1:Node[], layer2:Node[], layer3:Node[]):boolean{\r\n\r\n        let layer1Result = layer1.findLast((item:Node)=>{\r\n            return item\r\n        })\r\n\r\n        let layer2Result = layer2.findLast((item:Node)=>{\r\n            return item\r\n        })\r\n\r\n        let layer3Result = layer3.findLast((item:Node)=>{\r\n            return item\r\n        })\r\n\r\n        if((layer1Result.name === layer2Result.name) && (layer1Result.name === layer3Result.name)){\r\n            return true\r\n        }else{\r\n            return false\r\n        }\r\n\r\n    }\r\n\r\n    /**\r\n     * 滾動結束後移除全部layer子節點\r\n     * @param layout1 \r\n     * @param layout2 \r\n     * @param layout3 \r\n     */\r\n    removeLayersChildren(layout1:Layout, layout2:Layout, layout3:Layout){\r\n\r\n        this.removeChilds(layout1, this.layer1Pics)\r\n        this.removeChilds(layout2, this.layer2Pics)\r\n        this.removeChilds(layout3, this.layer3Pics)\r\n\r\n    }\r\n\r\n    /**\r\n     * 滾動結束後移除layer子節點，但保留最後一個\r\n     * @param layout \r\n     * @param pictureArray \r\n     */\r\n    removeChilds(layout:Layout, pictureArray:Node[]){\r\n\r\n        let lastNode = pictureArray.findLast((item)=>{\r\n            return item\r\n        })\r\n\r\n        for(let node of pictureArray){\r\n            if(node !== lastNode){\r\n                layout.node.removeChild(node)\r\n            }\r\n        }\r\n        pictureArray.splice(0, pictureArray.length-1)\r\n\r\n    }\r\n\r\n    /**\r\n     * 重製全部layer位置\r\n     * @param layout1 \r\n     * @param layout2 \r\n     * @param layout3 \r\n     */\r\n    resetLayers(layout1:Layout, layout2:Layout, layout3:Layout){\r\n\r\n        this.resetLayout(layout1)\r\n        this.resetLayout(layout2)\r\n        this.resetLayout(layout3)\r\n\r\n    }\r\n\r\n    /**\r\n     * 重製layer位置\r\n     * @param layout \r\n     */\r\n    resetLayout(layout:Layout){\r\n\r\n        layout.node.setPosition(new Vec3(0, 0, 0))\r\n\r\n    }\r\n\r\n    /**\r\n     * 生成三個layer的滾動圖\r\n     * @param layout1 \r\n     * @param layout2 \r\n     * @param layout3 \r\n     */\r\n    async generateAllPictureRoll(layout1:Layout, layout2:Layout, layout3:Layout){\r\n\r\n        await this.generatePictureRoll(layout1, this.layer1Pics)\r\n        await this.generatePictureRoll(layout2, this.layer2Pics)\r\n        await this.generatePictureRoll(layout3, this.layer3Pics)\r\n\r\n    }\r\n\r\n    /**\r\n     * 生成單個layer的滾動圖\r\n     * @param layout \r\n     * @param picutreArray \r\n     */\r\n    async generatePictureRoll(layout:Layout, picutreArray:Node[]){\r\n\r\n        const promises = [];\r\n\r\n        for (let i = 0; i < 20; i++) {\r\n            const num = Math.floor(Math.random() * 2 + 1);\r\n\r\n            const promise = new Promise((resolve, reject) => {\r\n                resources.load(`prefabs/${this.getPicturePath(num)}`, Prefab, (err, prefab) => {\r\n                    if (err) {\r\n                        reject(err);\r\n                    } else {\r\n                        const newNode = instantiate(prefab);\r\n                        resolve(newNode);\r\n                    }\r\n                });\r\n            });\r\n\r\n            promises.push(promise);\r\n        }\r\n\r\n        const nodes = await Promise.all(promises);\r\n\r\n        const shuffledNodes = nodes.sort(() => Math.random() - 0.5);\r\n\r\n        shuffledNodes.forEach((node, index) => {\r\n            picutreArray.push(node);\r\n            layout.node.insertChild(node, index + 1);\r\n        })\r\n\r\n    }\r\n\r\n    /**\r\n     * 所有layer開啟緩動滾動\r\n     * @param layout1 \r\n     * @param layout2 \r\n     * @param layout3 \r\n     * @returns \r\n     */\r\n    tweenAllLayerPicture(layout1:Layout, layout2:Layout, layout3:Layout){\r\n\r\n        return Promise.all([\r\n            this.tweenPictures(layout1),\r\n            this.tweenPictures(layout2),\r\n            this.tweenPictures(layout3)\r\n        ])\r\n            \r\n    }\r\n\r\n    /**\r\n     * 滾動layer的圖\r\n     * @param layout \r\n     * @returns \r\n     */\r\n    tweenPictures(layout:Layout){\r\n\r\n        return new Promise((resolve)=>{\r\n\r\n            tween(layout.node)\r\n                .to(4, {\r\n                    position: new Vec3(0, this.pictureHeight * 20, 0),\r\n                }, {\r\n                    easing: 'sineInOut',\r\n                }).call(()=>{\r\n                    resolve(true)\r\n                })\r\n                .start()\r\n        })\r\n\r\n    }\r\n\r\n}\r\n\r\n\r\n\r\n"]}