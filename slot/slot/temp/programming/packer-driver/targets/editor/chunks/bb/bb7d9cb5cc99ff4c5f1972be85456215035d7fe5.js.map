{"version":3,"sources":["file:///C:/Cocos/solt/assets/scripts/GameController-001.ts"],"names":["_decorator","Component","instantiate","Layout","Node","Prefab","resources","tween","Vec3","Animation","Label","MusicController","ccclass","property","GameController","type","layer1Pics","layer2Pics","layer3Pics","bingoTime","throttledStartGame","start","throttle","startGame","bind","load","err","prefab","newNode1","newNode2","newNode3","push","layout1","node","addChild","layout2","layout3","update","deltaTime","audioManager","playRollingMusic","removeChilds","resetLayout","rollPicture","Promise","all","tweenPictures","then","checkResult","layer1","layer2","layer3","layer1Result","findLast","item","layer2Result","layer3Result","name","bingoNode","active","playBingoMusic","getChildByName","getComponent","string","toString","layout","pictureArray","lastNode","removeChild","splice","length","setPosition","picutreArray","promises","i","num","Math","floor","random","promise","resolve","reject","newNode","nodes","shuffledNodes","sort","forEach","index","insertChild","layoutX","getPosition","x","to","position","easing","call","fun","delay","lastPlayTime","args","nowTime","Date","now","goStart","ani","handleBar1","play"],"mappings":"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","sourcesContent":["import { _decorator, Component, instantiate, Layout, Node, Prefab, resources, SpriteFrame, tween, Vec2, Vec3, Animation, Label } from 'cc';\r\nimport { MusicController } from './MusicController';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('GameController')\r\nexport class GameController extends Component {\r\n\r\n    @property({type:Layout})\r\n    private layout1:Layout = null\r\n\r\n    @property({type:Layout})\r\n    private layout2:Layout = null\r\n\r\n    @property({type:Layout})\r\n    private layout3:Layout = null\r\n\r\n    @property({type:Node})\r\n    private handleBar1:Node = null\r\n\r\n    @property({type:MusicController})\r\n    private audioManager:MusicController = null \r\n\r\n    @property({type:Node})\r\n    private bingoNode:Node = null\r\n\r\n\r\n\r\n\r\n    private layer1Pics:Node[] = []\r\n\r\n    private layer2Pics:Node[] = []\r\n\r\n    private layer3Pics:Node[] = []\r\n\r\n    private bingoTime = 0\r\n\r\n    private throttledStartGame:() => void\r\n\r\n\r\n    start() {\r\n\r\n        this.throttledStartGame = this.throttle(this.startGame.bind(this), 5000)\r\n\r\n        resources.load(`prefabs/SLOT_Picture1`, Prefab, (err, prefab)=>{\r\n            const newNode1 = instantiate(prefab)\r\n            const newNode2 = instantiate(prefab)\r\n            const newNode3 = instantiate(prefab)\r\n\r\n            this.layer1Pics.push(newNode1)\r\n            this.layer2Pics.push(newNode2)\r\n            this.layer3Pics.push(newNode3)\r\n\r\n            this.layout1.node.addChild(newNode1)\r\n            this.layout2.node.addChild(newNode2)\r\n            this.layout3.node.addChild(newNode3)\r\n        })\r\n    }\r\n\r\n    update(deltaTime: number) {\r\n    }\r\n\r\n    async startGame(){\r\n        this.audioManager.playRollingMusic()\r\n        this.removeChilds(this.layout1, this.layer1Pics)\r\n        this.removeChilds(this.layout2, this.layer2Pics)\r\n        this.removeChilds(this.layout3, this.layer3Pics)\r\n\r\n        this.resetLayout(this.layout1)\r\n        this.resetLayout(this.layout2)\r\n        this.resetLayout(this.layout3)\r\n        \r\n\r\n        await this.rollPicture(this.layout1, this.layer1Pics)\r\n        await this.rollPicture(this.layout2, this.layer2Pics)\r\n        await this.rollPicture(this.layout3, this.layer3Pics)\r\n        \r\n        Promise.all([\r\n            this.tweenPictures(this.layout1),\r\n            this.tweenPictures(this.layout2),\r\n            this.tweenPictures(this.layout3)\r\n        ]).then(()=>{\r\n            this.checkResult(this.layer1Pics, this.layer2Pics, this.layer3Pics)\r\n        })\r\n\r\n    }\r\n\r\n    checkResult(layer1, layer2, layer3){\r\n        let layer1Result = layer1.findLast((item)=>{\r\n            return item\r\n        })\r\n\r\n        let layer2Result = layer2.findLast((item)=>{\r\n            return item\r\n        })\r\n\r\n        let layer3Result = layer3.findLast((item)=>{\r\n            return item\r\n        })\r\n\r\n        if((layer1Result.name === layer2Result.name) && (layer1Result.name === layer3Result.name)){\r\n            this.bingoNode.active = true\r\n            this.audioManager.playBingoMusic()\r\n            this.bingoNode.getChildByName('Score').getComponent(Label).string = (++this.bingoTime*100).toString()\r\n        }\r\n\r\n  \r\n    }\r\n\r\n    removeChilds(layout, pictureArray){\r\n        let lastNode = pictureArray.findLast((item)=>{\r\n            return item\r\n        })\r\n\r\n        for(let node of pictureArray){\r\n            if(node !== lastNode){\r\n                layout.node.removeChild(node)\r\n            }\r\n        }\r\n        pictureArray.splice(0, pictureArray.length-1)\r\n    }\r\n\r\n    resetLayout(layout){\r\n        layout.node.setPosition(new Vec3(0, 0, 0))\r\n    }\r\n\r\n    async rollPicture(layout, picutreArray){\r\n        const promises = [];\r\n\r\n        for (let i = 0; i < 20; i++) {\r\n            const num = Math.floor(Math.random() * 2 + 1);\r\n\r\n            const promise = new Promise((resolve, reject) => {\r\n                resources.load(`prefabs/SLOT_Picture${num}`, Prefab, (err, prefab) => {\r\n                    if (err) {\r\n                        reject(err);\r\n                    } else {\r\n                        const newNode = instantiate(prefab);\r\n                        resolve(newNode);\r\n                    }\r\n                });\r\n            });\r\n\r\n            promises.push(promise);\r\n        }\r\n\r\n        const nodes = await Promise.all(promises);\r\n\r\n        // 打乱顺序\r\n        const shuffledNodes = nodes.sort(() => Math.random() - 0.5);\r\n\r\n        // 插入到布局和数组中\r\n        shuffledNodes.forEach((node, index) => {\r\n            picutreArray.push(node);\r\n            layout.node.insertChild(node, index + 1);\r\n        })\r\n    }\r\n\r\n    tweenPictures(layout){\r\n\r\n        return new Promise((resolve)=>{\r\n            // 开始 layout 的缓动\r\n            const layoutX = layout.node.getPosition().x;\r\n\r\n            tween(layout.node)\r\n                .to(4, {\r\n                    position: new Vec3(layoutX, 850 * 20, 0),\r\n                }, {\r\n                    easing: 'sineInOut',\r\n                }).call(()=>{\r\n                    resolve(true)\r\n                })\r\n                .start()\r\n        })\r\n    }\r\n\r\n    throttle(fun, delay){\r\n        let lastPlayTime = 0\r\n\r\n        return (...args)=>{\r\n            let nowTime = Date.now()\r\n            if(nowTime - lastPlayTime >= delay){\r\n                fun(...args)\r\n                lastPlayTime = nowTime\r\n            }\r\n        }\r\n    }\r\n\r\n    goStart(){\r\n        let ani = this.handleBar1.getComponent(Animation)\r\n        ani.play('handelbar')\r\n        this.throttledStartGame()\r\n    }\r\n\r\n}\r\n\r\n\r\n"]}